import kotlin.io.encoding.Base64

repositories {
    mavenCentral()
}

dependencies {
    project(":hyperkit-dto-generator-core")
}

// To avoid manual errors when changing the project version, the pom.xml is autogenerated from a template.
// It is done with a template instead of using a variable in the pom.xml file because deploying the plugin requires the version to not be derived from a variable
val generatePomFromTemplate by tasks.registering() {
    group = "build"
    description =
        "Uses pom.xml.templ as a template to create the pom.xml file that will be used to run the plugin building tasks"

    val templateFile = layout.projectDirectory.file("pom.xml.templ")
    val outputFile = layout.projectDirectory.file("pom.xml")

    // Declare inputs/outputs for Gradle up-to-date checks
    inputs.file(templateFile)
    outputs.file(outputFile)

    // Template variables
    val propsProvider = providers.provider {
        mapOf(
            "hyperkit.version" to project.version.toString()
        )
    }

    val props = propsProvider.get()
    inputs.properties(props)

    doLast {

        val template = templateFile.asFile.readText(Charsets.UTF_8)

        val rendered = props.entries.fold(template) { acc, (k, v) ->
            acc.replace("{{$k}}", v)
        }

        val out = outputFile.asFile
        out.parentFile.mkdirs()
        out.writeText(rendered, Charsets.UTF_8)

    }
}

val clean by tasks.registering(MavenExec::class) {
    group = "build"
    workingDir = project.projectDir
    mavenGoal = "clean"
    args("-Dhyperkit.version=$version")
}

val compile by tasks.registering(MavenExec::class) {
    group = "build"
    workingDir = project.projectDir
    mavenGoal = "compile"
    args("-Dhyperkit.version=$version", "-s", "settings.xml")
    dependsOn(generatePomFromTemplate)
    dependsOn(":hyperkit-dto-api:publishMavenPublicationToMavenLocal")
    dependsOn(":hyperkit-dto-generator-core:publishMavenPublicationToMavenLocal")
}

val test by tasks.registering(MavenExec::class) {
    group = "build"
    workingDir = project.projectDir
    mavenGoal = "test"
    args("-Dhyperkit.version=$version", "-s", "settings.xml")
    dependsOn(generatePomFromTemplate)
    dependsOn(":hyperkit-dto-api:publishMavenPublicationToMavenLocal")
    dependsOn(":hyperkit-dto-generator-core:publishMavenPublicationToMavenLocal")
}

val check by tasks.registering(DefaultTask::class) {
    group = "build"
    dependsOn(test)
}

fun getDecodedSecretKey(): String? {
    val secretKeyB64 = System.getenv("MAVEN_SIGNING_SECRET_KEY_B64")
    return secretKeyB64?.let { String(Base64.decode(secretKeyB64)) }
}

val install by tasks.registering(MavenExec::class) {
    group = "publishing"
    workingDir = project.projectDir
    mavenGoal = "install"
    args("-Dhyperkit.version=$version", "-s", "settings.xml")
    val decodedSecretKey = getDecodedSecretKey()
    if (decodedSecretKey != null) {
        environment("MAVEN_SIGNING_SECRET_KEY", decodedSecretKey)
    }
    println(System.getenv("MAVEN_SIGNING_SECRET_KEY"))
    dependsOn(check)
    dependsOn(":hyperkit-dto-api:publishMavenPublicationToMavenLocal")
    dependsOn(":hyperkit-dto-generator-core:publishMavenPublicationToMavenLocal")
    mustRunAfter(check)
}

val deploy by tasks.registering(MavenExec::class) {
    group = "publishing"
    workingDir = project.projectDir
    mavenGoal = "deploy"
    args("-Dhyperkit.version=$version", "-s", "settings.xml", "-DpublishArtifacts=true")
    val decodedSecretKey = getDecodedSecretKey()
    if (decodedSecretKey != null) {
        environment("MAVEN_SIGNING_SECRET_KEY", decodedSecretKey)
    }
    dependsOn(generatePomFromTemplate)
    dependsOn(":hyperkit-dto-api:publishMavenPublicationToMavenLocal")
    dependsOn(":hyperkit-dto-generator-core:publishMavenPublicationToMavenLocal")
}